<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CometChat Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CSS STYLES --- */
        :root { --primary-color: #34495e; --accent-color: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f0f2f5; display: flex; height: 100vh; overflow: hidden; }
        
        /* LOGIN SCREEN */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary-color); z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
        #login-screen input { padding: 12px; font-size: 16px; border-radius: 5px; border: none; margin-bottom: 15px; width: 250px; text-align: center; }
        #login-screen button { padding: 12px 30px; font-size: 16px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        
        /* SIDEBAR */
        #sidebar { width: 260px; background: var(--primary-color); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        #sidebar h2 { margin-top: 0; font-size: 20px; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 20px; letter-spacing: 1px; }
        .nav-btn { background: none; border: none; color: #bdc3c7; text-align: left; padding: 12px; font-size: 15px; cursor: pointer; transition: 0.2s; border-radius: 6px; margin-bottom: 5px; display: flex; align-items: center; }
        .nav-btn:hover, .nav-btn.active { background: rgba(255,255,255,0.1); color: white; padding-left: 18px; }
        .lock-btn { margin-top: auto; background: #e74c3c; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center; }

        /* MAIN CONTENT */
        #main-content { flex: 1; padding: 30px; overflow-y: auto; display: none; background: #ecf0f1; } 
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        
        /* CARDS & UTILS */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .row { display: flex; gap: 20px; }
        .col { flex: 1; }
        h3 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center; }
        
        /* FORMS & INPUTS */
        .form-group { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 6px; flex: 1; font-size: 14px; }
        input:disabled { background: #f8f9fa; color: #999; cursor: not-allowed; }

        /* BUTTONS */
        button.action-btn { padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button.action-btn:hover { opacity: 0.9; }
        button.cancel-btn { background: #95a5a6; color:white; border:none; padding:10px 20px; border-radius:6px; cursor:pointer; display:none; }
        
        /* TABLE BUTTONS */
        .btn-sm { padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; margin-right: 2px; color: white; }
        .edit-btn { background: #f39c12; }
        .delete-btn { background: #e74c3c; }
        .block-btn { background: #34495e; }
        .unblock-btn { background: #27ae60; }
        .csv-btn { background: #27ae60; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer; font-size:12px; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #7f8c8d; font-weight: 600; font-size:13px; }
        td { padding: 12px; border-bottom: 1px solid #eee; color: #2c3e50; vertical-align: middle; font-size:14px; }

        /* LOGS */
        .log-entry { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .log-content { max-width: 85%; }
        .log-meta { color: #95a5a6; font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; }
        .message-bubble { background: #f1f2f6; padding: 8px 12px; border-radius: 8px; display: inline-block; }
        .banned-word { color: red; font-weight: bold; text-decoration: underline; }

        /* MODAL */
        #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; justify-content:center; align-items:center; }
        #modal-box { background:white; padding:30px; border-radius:8px; width:500px; max-height:80vh; overflow-y:auto; position:relative; }
        .close-modal { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 id="login-title">üõ°Ô∏è Command Center</h2>
        <p style="margin-top:0; color:#bdc3c7; font-size:14px; margin-bottom:30px;"><b>Please enter the password below</b></p>
        <input type="password" id="passwordInput" placeholder="Enter password here">
        <button onclick="attemptLogin()">Unlock Dashboard</button>
        <p id="loginError" style="color: #e74c3c; display: none; margin-top:15px;">‚õî Access Denied</p>
    </div>

    <div id="sidebar" style="display: none;">
        <h2 id="sidebar-title">‚ö° Admin Panel</h2>
        <button class="nav-btn active" onclick="showSection('analytics')">üìä Analytics</button>
        <button class="nav-btn" onclick="showSection('users')">üë• Users</button>
        <button class="nav-btn" onclick="showSection('groups')">üì¢ Groups</button>
        <button class="nav-btn" onclick="showSection('chatlogs')">üí¨ Chat Inspector</button>
        <button class="nav-btn" onclick="showSection('broadcast')">üì° Broadcast</button>
        <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è Settings</button>
        
        <div style="margin-top:auto">
            <div id="role-display" style="font-size:11px; text-align:center; margin-bottom:10px; color:#bdc3c7;">Role: Guest</div>
            <button class="lock-btn" onclick="lockDashboard()">üîí Lock</button>
        </div>
    </div>

    <div id="main-content">
        
        <div id="analytics" class="section active">
            <div class="row">
                <div class="col card">
                    <h3>User Distribution</h3>
                    <canvas id="userChart"></canvas>
                </div>
                <div class="col card">
                    <h3>Platform Activity</h3>
                    <div style="text-align:center; padding:20px;">
                        <h1 style="font-size:48px; margin:0; color:var(--accent-color)" id="totalUsersCount">0</h1>
                        <p>Total Users</p>
                        <h1 style="font-size:48px; margin:0; color:#27ae60" id="totalGroupsCount">0</h1>
                        <p>Active Groups</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="users" class="section">
            <div class="card">
                <h3 id="userFormTitle">Create / Edit User</h3>
                <div class="form-group">
                    <input type="text" id="userUid" placeholder="UID (Unique ID)">
                    <input type="text" id="userName" placeholder="Display Name">
                    <input type="text" id="userAvatar" placeholder="Avatar URL">
                    <button class="action-btn" id="saveUserBtn" onclick="saveUser()">+ Add User</button>
                    <button class="cancel-btn" id="cancelUserBtn" onclick="resetUserForm()">Cancel</button>
                </div>
            </div>
            <div class="card">
                <h3>
                    User Database
                    <div>
                        <input type="text" id="searchUser" placeholder="Search..." onkeyup="filterTable('searchUser', 'userTable')" style="width:150px; padding:6px;">
                        <button class="csv-btn" onclick="exportTableToCSV('userTable', 'users.csv')">üì• CSV</button>
                    </div>
                </h3>
                <table id="userTable">
                    <thead><tr><th style="width:30px"></th><th>Avatar</th><th>UID</th><th>Name</th><th>Metadata</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="groups" class="section">
            <div class="card">
                <h3 id="groupFormTitle">Create / Edit Group</h3>
                <div class="form-group">
                    <input type="text" id="groupGuid" placeholder="GUID">
                    <input type="text" id="groupName" placeholder="Group Name">
                    <select id="groupType"><option value="public">Public</option><option value="private">Private</option></select>
                    <button class="action-btn" id="saveGroupBtn" onclick="saveGroup()">+ Create</button>
                    <button class="cancel-btn" id="cancelGroupBtn" onclick="resetGroupForm()">Cancel</button>
                </div>
            </div>
            <div class="card">
                <h3>
                    Active Groups
                    <div>
                        <input type="text" id="searchGroup" placeholder="Search..." onkeyup="filterTable('searchGroup', 'groupTable')" style="width:150px; padding:6px;">
                        <button class="csv-btn" onclick="exportTableToCSV('groupTable', 'groups.csv')">üì• CSV</button>
                    </div>
                </h3>
                <table id="groupTable">
                    <thead><tr><th style="width:30px"></th><th>GUID</th><th>Name</th><th>Type</th><th>Members</th><th>Actions</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="chatlogs" class="section">
            <div class="card">
                <h3>üîç Message Inspector</h3>
                <div class="form-group">
                    <input type="text" id="logId" placeholder="Enter UID or GUID">
                    <select id="logType"><option value="users">User (1-on-1)</option><option value="groups">Group</option></select>
                    <button class="action-btn" onclick="fetchChatLogs()">Fetch History</button>
                </div>
                <div style="font-size:12px; color:#999; margin-top:5px;">
                    *Auto-Moderation active. Banned words: <i>spam, fake, scam, hate</i>
                </div>
            </div>
            <div class="card" id="chatLogResults" style="max-height: 500px; overflow-y: auto;"></div>
        </div>

        <div id="broadcast" class="section">
            <div class="card">
                <h3>üì° Global Broadcast</h3>
                <p>Send a system message to a specific channel.</p>
                <div class="form-group">
                    <input type="text" id="broadcastTarget" placeholder="Target GUID (e.g. 'general')">
                    <input type="text" id="broadcastMsg" placeholder="Message content">
                </div>
                <button class="action-btn" onclick="sendBroadcast()">üöÄ Send Broadcast</button>
            </div>
        </div>

        <div id="settings" class="section">
            <div class="card">
                <h3>üé® Custom Branding</h3>
                <div class="form-group">
                    <label>Dashboard Title:</label>
                    <input type="text" id="settingTitle" placeholder="My Company Admin">
                </div>
                <div class="form-group">
                    <label>Theme Color:</label>
                    <input type="color" id="settingColor" value="#34495e">
                </div>
                <button class="action-btn" onclick="saveSettings()">Save Branding</button>
                <button class="csv-btn" style="background:#95a5a6" onclick="clearSettings()">Reset Default</button>
            </div>
        </div>

    </div>

    <div id="modal-overlay">
        <div id="modal-box">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h3 id="modal-title">Details</h3>
            <div id="modal-content">Loading...</div>
        </div>
    </div>

    <script>
        // ================= CONFIGURATION =================
        const APP_ID = "16690658bf8acd328";
        const REGION = "eu";
        const REST_API_KEY = "8031bed1942057c0bb44a1a0710ddb3875079025"; // <--- PASTE API KEY HERE
        
        const ADMIN_PASS = "c0nsp1racy";
        const MOD_PASS = "mod_pass";
        const BANNED_WORDS = ["spam", "scam", "fake", "hate"];
        // =================================================

        const HEADERS = { "apiKey": REST_API_KEY, "Content-Type": "application/json", "Accept": "application/json" };
        const BASE_URL = `https://${APP_ID}.api-${REGION}.cometchat.io/v3`;
        
        let currentRole = null;
        let isEditingUser = false;
        let isEditingGroup = false;

        // --- 1. INITIALIZATION & SESSION ---
        window.onload = function() { loadSettings(); checkSession(); }

        function checkSession() {
            const sessionRole = localStorage.getItem("dashboardRole");
            const sessionTime = localStorage.getItem("dashboardSession");
            if(sessionRole && sessionTime && (new Date().getTime() - sessionTime < 86400000)) loginSuccess(sessionRole);
        }

        function attemptLogin() {
            const input = document.getElementById("passwordInput").value;
            if(input === ADMIN_PASS) loginSuccess('admin');
            else if(input === MOD_PASS) loginSuccess('mod');
            else document.getElementById("loginError").style.display = "block";
        }

        function loginSuccess(role) {
            currentRole = role;
            localStorage.setItem("dashboardRole", role);
            localStorage.setItem("dashboardSession", new Date().getTime());
            document.getElementById("login-screen").style.display = "none";
            document.getElementById("sidebar").style.display = "flex";
            document.getElementById("main-content").style.display = "block";
            document.getElementById("role-display").innerText = "Role: " + role.toUpperCase();
            fetchUsers(); fetchGroups(); updateAnalytics();
        }

        function lockDashboard() {
            localStorage.removeItem("dashboardRole");
            localStorage.removeItem("dashboardSession");
            location.reload();
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- 2. ANALYTICS ---
        async function updateAnalytics() {
            try {
                const uRes = await fetch(`${BASE_URL}/users?per_page=100`, { headers: HEADERS });
                const gRes = await fetch(`${BASE_URL}/groups?per_page=100`, { headers: HEADERS });
                const uData = await uRes.json();
                const gData = await gRes.json();
                
                const uCount = uData.data.length;
                const gCount = gData.data.length;

                document.getElementById("totalUsersCount").innerText = uCount;
                document.getElementById("totalGroupsCount").innerText = gCount;

                const ctx = document.getElementById('userChart').getContext('2d');
                if(window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Users', 'Groups'],
                        datasets: [{ data: [uCount, gCount], backgroundColor: ['#3498db', '#2ecc71'] }]
                    }
                });
            } catch(e) { console.log("Analytics Error", e); }
        }

        // --- 3. USER MANAGEMENT (Edit & Unblock Added) ---
        async function fetchUsers() {
            const res = await fetch(`${BASE_URL}/users?per_page=100`, { headers: HEADERS });
            const data = await res.json();
            const tbody = document.querySelector("#userTable tbody");
            tbody.innerHTML = "";
            data.data.forEach(u => {
                const meta = u.metadata && u.metadata.status === "blocked" ? "üî¥ BLOCKED" : "üü¢ Active";
                const isBlocked = u.metadata && u.metadata.status === "blocked";
                
                // Button Logic: Admin sees Delete/Edit/Block/Unblock
                let actions = "";
                if(currentRole === 'admin') {
                    actions += `<button class="btn-sm edit-btn" onclick="startEditUser('${u.uid}', '${u.name}', '${u.avatar || ''}')">Edit</button>`;
                    if(isBlocked) {
                        actions += `<button class="btn-sm unblock-btn" onclick="unblockUser('${u.uid}', '${u.name}')">Unblock</button>`;
                    } else {
                        actions += `<button class="btn-sm block-btn" onclick="blockUser('${u.uid}', '${u.name}')">Block</button>`;
                    }
                    actions += `<button class="btn-sm delete-btn" onclick="deleteUser('${u.uid}')">üóëÔ∏è</button>`;
                } else {
                    actions = "<span style='color:#ccc'>Read Only</span>";
                }

                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="chk-user" value="${u.uid}"></td>
                        <td><img src="${u.avatar || 'https://via.placeholder.com/30'}" width="30" style="border-radius:50%"></td>
                        <td>${u.uid}</td>
                        <td>${u.name}</td>
                        <td style="font-size:11px;">${meta}</td>
                        <td>${actions}</td>
                    </tr>`;
            });
        }

        // START EDIT USER
        function startEditUser(uid, name, avatar) {
            isEditingUser = true;
            document.getElementById("userFormTitle").innerText = "Edit User: " + uid;
            document.getElementById("userUid").value = uid;
            document.getElementById("userUid").disabled = true; // Can't change UID
            document.getElementById("userName").value = name;
            document.getElementById("userAvatar").value = avatar;
            
            document.getElementById("saveUserBtn").innerText = "üíæ Save Changes";
            document.getElementById("saveUserBtn").style.backgroundColor = "#f39c12";
            document.getElementById("cancelUserBtn").style.display = "inline-block";
            
            window.scrollTo(0, 0); // Scroll to form
        }

        // CANCEL EDIT USER
        function resetUserForm() {
            isEditingUser = false;
            document.getElementById("userFormTitle").innerText = "Create / Edit User";
            document.getElementById("userUid").value = "";
            document.getElementById("userUid").disabled = false;
            document.getElementById("userName").value = "";
            document.getElementById("userAvatar").value = "";
            
            document.getElementById("saveUserBtn").innerText = "+ Add User";
            document.getElementById("saveUserBtn").style.backgroundColor = "#3498db";
            document.getElementById("cancelUserBtn").style.display = "none";
        }

        // SAVE (Create or Update)
        async function saveUser() {
            if(currentRole !== 'admin') return alert("Admins only.");
            const uid = document.getElementById("userUid").value;
            const name = document.getElementById("userName").value;
            const avatar = document.getElementById("userAvatar").value;

            if(!uid || !name) return alert("UID/Name required");

            const payload = { name, avatar };
            let url = `${BASE_URL}/users`;
            let method = "POST";

            if(isEditingUser) {
                // Update Mode
                url = `${BASE_URL}/users/${uid}`;
                method = "PUT";
            } else {
                // Create Mode
                payload.uid = uid;
            }

            await fetch(url, { method: method, headers: HEADERS, body: JSON.stringify(payload) });
            fetchUsers();
            updateAnalytics();
            resetUserForm(); // Reset form after save
        }

        // BLOCK / UNBLOCK Logic
        async function blockUser(uid, currentName) {
            if(!confirm(`Block ${uid}? They will be marked as blocked.`)) return;
            const newName = `[BLOCKED] ${currentName}`;
            await fetch(`${BASE_URL}/users/${uid}`, { 
                method: "PUT", headers: HEADERS, 
                body: JSON.stringify({ name: newName, metadata: { status: "blocked" } }) 
            });
            fetchUsers();
        }

        async function unblockUser(uid, currentName) {
            if(!confirm(`Unblock ${uid}?`)) return;
            // Remove the "[BLOCKED] " tag from the name
            const cleanName = currentName.replace("[BLOCKED] ", "");
            await fetch(`${BASE_URL}/users/${uid}`, { 
                method: "PUT", headers: HEADERS, 
                body: JSON.stringify({ name: cleanName, metadata: { status: "active" } }) 
            });
            fetchUsers();
        }

        async function deleteUser(uid) {
            if(!confirm("Permanently delete?")) return;
            await fetch(`${BASE_URL}/users/${uid}`, { method: "DELETE", headers: HEADERS });
            fetchUsers();
            updateAnalytics();
        }

        // --- 4. GROUP MANAGEMENT (Edit Added) ---
        async function fetchGroups() {
            const res = await fetch(`${BASE_URL}/groups?per_page=100`, { headers: HEADERS });
            const data = await res.json();
            const tbody = document.querySelector("#groupTable tbody");
            tbody.innerHTML = "";
            data.data.forEach(g => {
                let actions = "";
                if(currentRole === 'admin') {
                    actions += `<button class="btn-sm edit-btn" onclick="startEditGroup('${g.guid}', '${g.name}', '${g.type}')">Edit</button>`;
                    actions += `<button class="btn-sm delete-btn" onclick="deleteGroup('${g.guid}')">üóëÔ∏è</button>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" class="chk-group" value="${g.guid}"></td>
                        <td>${g.guid}</td>
                        <td>${g.name}</td>
                        <td>${g.type}</td>
                        <td><button class="btn-sm" style="background:#95a5a6" onclick="inspectGroup('${g.guid}')">Members</button></td>
                        <td>${actions}</td>
                    </tr>`;
            });
        }

        function startEditGroup(guid, name, type) {
            isEditingGroup = true;
            document.getElementById("groupFormTitle").innerText = "Edit Group: " + guid;
            document.getElementById("groupGuid").value = guid;
            document.getElementById("groupGuid").disabled = true;
            document.getElementById("groupName").value = name;
            document.getElementById("groupType").value = type;
            
            document.getElementById("saveGroupBtn").innerText = "üíæ Save Changes";
            document.getElementById("saveGroupBtn").style.backgroundColor = "#f39c12";
            document.getElementById("cancelGroupBtn").style.display = "inline-block";
            window.scrollTo(0, 0);
        }

        function resetGroupForm() {
            isEditingGroup = false;
            document.getElementById("groupFormTitle").innerText = "Create / Edit Group";
            document.getElementById("groupGuid").value = "";
            document.getElementById("groupGuid").disabled = false;
            document.getElementById("groupName").value = "";
            
            document.getElementById("saveGroupBtn").innerText = "+ Create";
            document.getElementById("saveGroupBtn").style.backgroundColor = "#3498db";
            document.getElementById("cancelGroupBtn").style.display = "none";
        }

        async function saveGroup() {
            if(currentRole !== 'admin') return alert("Admins only.");
            const guid = document.getElementById("groupGuid").value;
            const name = document.getElementById("groupName").value;
            const type = document.getElementById("groupType").value;

            const payload = { name, type };
            let url = `${BASE_URL}/groups`;
            let method = "POST";

            if(isEditingGroup) {
                url = `${BASE_URL}/groups/${guid}`;
                method = "PUT";
            } else {
                payload.guid = guid;
            }

            await fetch(url, { method: method, headers: HEADERS, body: JSON.stringify(payload) });
            fetchGroups();
            updateAnalytics();
            resetGroupForm();
        }
        
        async function deleteGroup(guid) {
            if(!confirm("Delete group?")) return;
            await fetch(`${BASE_URL}/groups/${guid}`, { method: "DELETE", headers: HEADERS });
            fetchGroups();
        }

        // --- 5. UTILS ---
        function filterTable(inputId, tableId) {
            const term = document.getElementById(inputId).value.toLowerCase();
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            rows.forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? "" : "none"; });
        }
        function exportTableToCSV(tableId, filename) {
            let csv = [];
            let rows = document.querySelectorAll(`#${tableId} tr`);
            for (let i = 0; i < rows.length; i++) {
                let row = [], cols = rows[i].querySelectorAll("td, th");
                for (let j = 1; j < cols.length - 1; j++) row.push(cols[j].innerText.replace(/,/g, "")); 
                csv.push(row.join(","));
            }
            let link = document.createElement("a");
            link.href = window.URL.createObjectURL(new Blob([csv.join("\n")], {type: "text/csv"}));
            link.download = filename;
            link.click();
        }

        // --- 6. LOGS, BROADCAST & SETTINGS (Standard) ---
        async function inspectGroup(guid) {
            document.getElementById("modal-overlay").style.display = "flex";
            document.getElementById("modal-title").innerText = "Members of " + guid;
            document.getElementById("modal-content").innerText = "Loading...";
            const res = await fetch(`${BASE_URL}/groups/${guid}/members`, { headers: HEADERS });
            const data = await res.json();
            let html = "<ul style='padding-left:20px'>";
            data.data.forEach(m => { html += `<li><b>${m.name}</b> (${m.uid}) - ${m.scope}</li>`; });
            html += "</ul>";
            document.getElementById("modal-content").innerHTML = html;
        }
        function closeModal() { document.getElementById("modal-overlay").style.display = "none"; }
        
        async function fetchChatLogs() {
            const id = document.getElementById("logId").value;
            const type = document.getElementById("logType").value;
            const container = document.getElementById("chatLogResults");
            container.innerHTML = "Loading...";
            const res = await fetch(`${BASE_URL}/${type}/${id}/messages`, { headers: HEADERS });
            const data = await res.json();
            container.innerHTML = "";
            if(!data.data || data.data.length === 0) return container.innerHTML = "No messages.";
            data.data.forEach(msg => {
                let content = msg.data.text || "";
                BANNED_WORDS.forEach(word => { if(content.toLowerCase().includes(word)) content = content.replace(new RegExp(word, "gi"), `<span class="banned-word">${word}</span>`); });
                container.innerHTML += `<div class="log-entry"><div class="log-content"><div class="log-meta">${msg.sender ? msg.sender.name : 'System'}</div><div class="message-bubble">${content}</div></div></div>`;
            });
        }
        
        async function sendBroadcast() {
            if(currentRole !== 'admin') return alert("Admins only.");
            const target = document.getElementById("broadcastTarget").value;
            const msg = document.getElementById("broadcastMsg").value;
            await fetch(`${BASE_URL}/messages`, { method: "POST", headers: HEADERS, body: JSON.stringify({ receiver: target, receiverType: "group", category: "message", type: "text", data: { text: "[SYSTEM]: " + msg } }) });
            alert("Broadcast sent!");
        }

        function saveSettings() {
            const title = document.getElementById("settingTitle").value;
            const color = document.getElementById("settingColor").value;
            localStorage.setItem("dashTitle", title);
            localStorage.setItem("dashColor", color);
            loadSettings(); alert("Settings Saved");
        }
        function loadSettings() {
            const title = localStorage.getItem("dashTitle");
            const color = localStorage.getItem("dashColor");
            if(title) { document.getElementById("login-title").innerText = title; document.getElementById("sidebar-title").innerText = title; }
            if(color) { document.documentElement.style.setProperty('--primary-color', color); document.getElementById("login-screen").style.backgroundColor = color; }
        }
        function clearSettings() { localStorage.removeItem("dashTitle"); localStorage.removeItem("dashColor"); location.reload(); }

    </script>
</body>
</html>